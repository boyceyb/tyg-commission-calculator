<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYG Commission Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Helvetica Neue', 'Arial', sans-serif; 
            background: #fafafa; 
            min-height: 100vh;
            padding: 24px; 
            color: #2c2c2c; 
            line-height: 1.4;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: white; 
            padding: 32px 48px; 
            margin-bottom: 32px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border-bottom: 3px solid #1e3a8a;
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .header-left { display: flex; align-items: center; }
        .logo { 
            font-weight: 700; 
            font-size: 24px; 
            letter-spacing: -0.5px; 
            color: #2c2c2c;
        }
        .logo .dash { 
            color: #1e3a8a; 
            margin: 0 2px; 
            font-weight: 300;
        }
        .title { margin-left: 40px; }
        .title h1 { 
            font-size: 24px; 
            font-weight: 600; 
            color: #2c2c2c; 
            margin: 0; 
            letter-spacing: -0.3px;
        }
        .title p { 
            font-size: 14px; 
            color: #666; 
            margin-top: 4px; 
            font-weight: 400;
        }
        .icon { 
            background: #2c2c2c; 
            padding: 12px; 
            color: white; 
            font-size: 20px; 
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
        .card { 
            background: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            padding: 40px; 
            border-left: 3px solid #f0f0f0;
            transition: all 0.2s ease;
        }
        .card:hover { 
            border-left-color: #1e3a8a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12); 
        }
        .card h3 { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 32px; 
            color: #2c2c2c; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            letter-spacing: -0.2px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .input-group { margin-bottom: 24px; }
        .input-group label { 
            display: block; 
            font-size: 12px; 
            font-weight: 600; 
            color: #666; 
            margin-bottom: 8px; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e0e0e0; 
            font-size: 15px; 
            background: white; 
            transition: all 0.2s ease; 
            font-weight: 400;
            color: #2c2c2c;
        }
        .input-group input:focus, .input-group select:focus { 
            outline: none; 
            border-color: #1e3a8a; 
            background: #fafafa;
        }
        .input-group input:hover, .input-group select:hover { 
            border-color: #ccc; 
        }
        .input-group small { 
            font-size: 11px; 
            color: #999; 
            margin-top: 6px; 
            display: block; 
            font-weight: 400;
        }
        .dual-input { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; }
        .toggle-container { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 20px; 
            background: #f8f8f8; 
            border: 2px solid #e0e0e0;
            margin-bottom: 24px; 
            transition: all 0.2s ease;
        }
        .toggle-container:hover { 
            border-color: #ccc; 
        }
        .toggle { 
            position: relative; 
            width: 48px; 
            height: 24px; 
            background: #ddd; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: background 0.2s ease; 
        }
        .toggle.active { 
            background: #1e3a8a; 
        }
        .toggle-thumb { 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            width: 20px; 
            height: 20px; 
            background: white; 
            border-radius: 10px; 
            transition: transform 0.2s ease; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        }
        .toggle.active .toggle-thumb { transform: translateX(24px); }
        .compact-toggle > div:first-child { 
            font-weight: 600; 
            color: #2c2c2c; 
            font-size: 14px; 
            letter-spacing: -0.2px;
        }
        .compact-toggle > div:last-child { 
            color: #666; 
            margin-top: 2px; 
            font-size: 12px; 
            font-weight: 400;
        }
        .breakdown { background: #f8fafc; padding: 16px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
        .breakdown h4 { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
        .breakdown-item { display: flex; justify-content: space-between; align-items: flex-start; font-size: 14px; margin-bottom: 12px; }
        .breakdown-left { color: #64748b; flex: 1; }
        .breakdown-right { font-weight: 500; color: #1e293b; margin-left: 16px; }
        .earnings-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
            font-size: 15px; 
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .earnings-item:last-child { 
            margin-bottom: 0; 
            padding: 24px; 
            margin: 24px -24px 0 -24px;
            border: none;
            background: #2c2c2c;
            font-size: 20px; 
            font-weight: 600; 
            color: white;
        }
        .earnings-item:last-child .earnings-label { 
            color: #ccc; 
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .earnings-item:last-child .earnings-value { 
            font-size: 24px; 
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        .earnings-label { 
            color: #666; 
            font-weight: 500;
            font-size: 12px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .earnings-value { 
            font-weight: 600; 
            letter-spacing: -0.3px;
            color: #2c2c2c;
        }
        .earnings-value.commission { color: #1e3a8a; }
        .earnings-value.salary { color: #666; }
        .earnings-value.team { color: #666; }
        .earnings-value.total { color: white; }
        .status { padding: 16px; border-radius: 6px; margin-bottom: 16px; }
        .status.success { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .status.error { background: #fef2f2; border: 1px solid #fecaca; }
        .status.info { background: #eff6ff; border: 1px solid #bfdbfe; }
        .status-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
        .status.success .status-title { color: #166534; }
        .status.error .status-title { color: #dc2626; }
        .status.info .status-title { color: #1d4ed8; }
        .status-text { font-size: 14px; color: #64748b; }
        .progress-container { margin-bottom: 16px; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .progress-label { font-size: 14px; font-weight: 500; color: #374151; }
        .progress-type { font-size: 12px; color: #64748b; }
        .progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #3b82f6, #10b981); transition: width 0.3s; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 4px; }
        .progress-remaining { font-size: 12px; color: #64748b; margin-top: 8px; }
        .promotion-badge { background: #dcfce7; color: #166534; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #bbf7d0; }
        .promotion-badge h4 { font-weight: 600; margin-bottom: 4px; }
        .next-deal-card { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .next-deal-card h4 { color: #0c4a6e; font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .deal-result { background: white; border-radius: 6px; padding: 16px; border: 1px solid #bae6fd; }
        .deal-value { font-size: 18px; font-weight: bold; color: #0c4a6e; margin-bottom: 4px; }
        .deal-rate { font-size: 14px; color: #0369a1; }
        .info-dropdown { 
            background: white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border-left: 3px solid #f0f0f0; 
            margin-bottom: 32px; 
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .info-dropdown:hover { border-left-color: #1e3a8a; }
        .info-toggle { 
            padding: 20px 24px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 14px; 
            font-weight: 600; 
            color: #2c2c2c; 
            transition: all 0.2s ease;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-toggle:hover { 
            background: #fafafa; 
        }
        .info-toggle.active { 
            background: #2c2c2c; 
            color: white;
            border-bottom-color: #2c2c2c;
        }
        .info-toggle .arrow { 
            transition: transform 0.2s ease; 
            color: #999; 
            font-size: 12px;
        }
        .info-toggle.active .arrow { 
            transform: rotate(180deg); 
            color: white;
        }
        .info-dropdown .info-content { 
            padding: 24px; 
            background: #fafafa;
        }
        .info-dropdown .info-item { 
            margin-bottom: 16px; 
            padding: 16px;
            background: white;
            border-left: 3px solid #1e3a8a;
            font-size: 13px;
            line-height: 1.5;
        }
        .info-dropdown .info-item:last-child { margin-bottom: 0; }
        .info-dropdown .info-item strong { 
            color: #2c2c2c; 
            font-weight: 600;
        }
        .info-dropdown .info-item { 
            color: #666; 
        }
        .reset-btn { background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; width: 100%; }
        .reset-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3); }
        .save-btn { background: #059669; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 12px; width: 100%; }
        .save-btn:hover { background: #047857; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .saved-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
        .saved-section h4 { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
        .saved-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 8px; font-size: 12px; }
        .saved-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .saved-item-title { font-weight: 600; color: #1e293b; }
        .saved-item-date { color: #64748b; font-size: 11px; }
        .saved-item-details { color: #64748b; }
        .saved-item-actions { margin-top: 8px; display: flex; gap: 8px; }
        .load-btn, .delete-btn { background: none; border: 1px solid #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .load-btn { color: #3b82f6; border-color: #3b82f6; }
        .load-btn:hover { background: #3b82f6; color: white; }
        .delete-btn { color: #ef4444; border-color: #ef4444; }
        .delete-btn:hover { background: #ef4444; color: white; }
        .section-divider { border-top: 1px solid #e2e8f0; margin: 24px 0 16px 0; padding-top: 20px; }
        .hidden { display: none; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .header { flex-direction: column; text-align: center; gap: 16px; } .header-left { flex-direction: column; gap: 16px; } .title { margin-left: 0; } .dual-input { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">TY<span class="dash">-</span>G</div>
                <div class="title">
                    <h1>Commission Calculator</h1>
                    <p>Calculate your earnings and track promotion progress</p>
                </div>
            </div>
            <div class="icon">üî¢</div>
        </div>
        
        <div class="info-dropdown">
            <div class="info-toggle" id="infoToggle">
                <span>‚ÑπÔ∏è Commission Information</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="info-content hidden" id="infoContent">
                <div class="info-item">
                    <strong>Exchange Rates:</strong> USD invoices converted using rate on payment received date
                </div>
                <div class="info-item">
                    <strong>Threshold & Commission:</strong> Calculated by invoice payment received date order
                </div>
                <div class="info-item">
                    <strong>Promotions:</strong> Based on invoice sent date order
                </div>
            </div>
        </div>
        <div class="grid">
            <div class="card">
                <h3>üéØ Your Seniority Level</h3>
                <div class="input-group">
                    <label>Your Starting Level for This Year</label>
                    <select id="currentLevel">
                        <option value="Consultant">Consultant</option>
                        <option value="Consultant II">Consultant II</option>
                        <option value="Senior Consultant">Senior Consultant</option>
                        <option value="Principal Consultant">Principal Consultant</option>
                    </select>
                    <small>This is your level at the start of your personal commission year (not calendar year)</small>
                </div>
                <div class="toggle-container compact-toggle" id="toggleContainer">
                    <div>
                        <div>First Year Fast-Track?</div>
                        <div>Available in your first 12 months</div>
                    </div>
                    <div class="toggle active" id="firstYearToggle">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
                
                <h3 style="margin-top: 24px;">üí∑ Your Billings</h3>
                <div class="input-group">
                    <label>Annual Billings (Year to Date)</label>
                    <div class="dual-input">
                        <input type="number" id="billings" placeholder="Enter your current billings...">
                        <select id="currency">
                            <option value="GBP">GBP (¬£)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>
                <div class="input-group hidden" id="exchangeGroup">
                    <label>USD/GBP Exchange Rate</label>
                    <input type="number" id="exchangeRate" value="0.75" step="0.01" placeholder="Exchange rate">
                    <small>Rate used is from the date invoice payment is received. <strong>Check current rates:</strong> <a href="https://www.xe.com/currencyconverter/convert/?Amount=1&From=USD&To=GBP" target="_blank" style="color: #1e3a8a;">XE.com</a></small>
                </div>
                
                <div class="input-group">
                    <label>Base Salary (Optional)</label>
                    <input type="number" id="baseSalary" placeholder="Add your base salary for total earnings...">
                </div>
                
                <div id="teamSection" class="hidden">
                    <div class="input-group">
                        <label>Team Annual Billings (¬£)</label>
                        <input type="number" id="teamBillings" placeholder="Team annual billings (¬£)">
                        <small>10% commission on team billings</small>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="next-deal-card">
                    <h4>üéØ Next Deal Calculator</h4>
                    <div class="input-group">
                        <label>Next Deal Value</label>
                        <input type="number" id="nextDealValue" placeholder="Deal value...">
                        <small>Calculate commission on your next specific deal</small>
                    </div>
                </div>
                
                <button class="reset-btn" id="resetButton">üîÑ Clear All Fields</button>
                <button class="save-btn" id="saveButton">üîñ Save Calculation</button>
                
                <div id="savedCalculations" class="saved-section hidden">
                    <h4>üìã Saved Calculations</h4>
                    <div id="savedList"></div>
                </div>
            </div>
            <div class="card">
                <h3>üìä Your Earnings</h3>
                
                <div id="emptyState" class="status info">
                    <div class="status-title">üí° Commission Thresholds</div>
                    <div class="status-text">
                        <strong>Consultant:</strong> ¬£35,000 minimum to earn commission<br>
                        <strong>All other levels:</strong> ¬£40,000 minimum to earn commission
                    </div>
                </div>
                
                <div id="breakdown" class="breakdown hidden">
                    <h4>Commission Breakdown:</h4>
                    <div id="breakdownItems"></div>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Commission</span>
                    <span class="earnings-value commission" id="commissionValue">¬£0</span>
                </div>
                <div class="earnings-item hidden" id="salaryRow">
                    <span class="earnings-label">Base Salary</span>
                    <span class="earnings-value salary" id="salaryValue">¬£0</span>
                </div>
                <div class="earnings-item hidden" id="teamBonusRow">
                    <span class="earnings-label">Team Bonus</span>
                    <span class="earnings-value team" id="teamBonusValue">¬£0</span>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Total Earnings</span>
                    <span class="earnings-value total" id="totalValue">¬£0</span>
                </div>
                
                <button class="export-btn" id="exportButton" style="margin-top: 16px; background: #3b82f6 !important; color: white !important; border: none !important; padding: 12px 20px !important; border-radius: 6px !important; font-size: 14px !important; font-weight: 600 !important; cursor: pointer !important; width: 100% !important; font-family: inherit !important;">üìÑ Export Results</button>
                
                <div id="thresholdStatus" class="status hidden">
                    <div class="status-title" id="statusTitle">Threshold Status</div>
                    <div class="status-text" id="statusText">Enter billings to see threshold status</div>
                </div>
                <div id="promotionProgress" class="hidden">
                    <h3 style="margin-top: 20px;">üìà Promotion Progress</h3>
                    <div id="promotionContent"></div>
                </div>
                
                <div id="nextDealResult" class="status info hidden">
                    <div class="status-title">üéØ Next Deal Commission</div>
                    <div class="deal-result">
                        <div class="deal-value" id="nextDealCommission">¬£0</div>
                        <div class="deal-rate" id="nextDealRate">Commission rate: 0%</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;" id="nextDealExplanation"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Commission structure constants
        const THRESHOLDS = {
            consultant: 35000,
            consultantii: 40000,
            seniorconsultant: 40000,
            principalconsultant: 40000
        };
        
        const PROMOTION_THRESHOLDS = {
            fastTrack: {
                consultantII: 100000,
                senior: 140000,
                principal: 180000
            },
            standard: {
                senior: 160000,
                principal: 200000
            }
        };

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(amount || 0));
        }

        // Get commission rate for current position
        function getCommissionRate(billings, level, isFirstYear) {
            const levelKey = level.toLowerCase().replace(/\s+/g, '');
            const threshold = THRESHOLDS[levelKey];
            
            if (billings < threshold) return 0;
            
            const commissionableBillings = billings - threshold;
            
            if (level === 'Consultant') {
                return isFirstYear ? getFirstYearRate(billings) : 0.20;
            } else if (level === 'Consultant II') {
                return 0.225;
            } else if (level === 'Senior Consultant') {
                return commissionableBillings <= 60000 ? 0.25 : 0.30;
            } else if (level === 'Principal Consultant') {
                return getPrincipalRate(commissionableBillings);
            }
            return 0;
        }

        function getFirstYearRate(billings) {
            if (billings >= PROMOTION_THRESHOLDS.fastTrack.principal) return 0.25; // Principal rate
            if (billings >= PROMOTION_THRESHOLDS.fastTrack.senior) return 0.25; // Senior rate
            if (billings >= PROMOTION_THRESHOLDS.fastTrack.consultantII) return 0.225; // Consultant II rate
            return 0.20; // Consultant rate
        }

        function getPrincipalRate(billings) {
            if (billings <= 60000) return 0.25;
            if (billings <= 160000) return 0.30;
            if (billings <= 260000) return 0.35;
            if (billings <= 360000) return 0.40;
            return 0.50;
        }

        // Calculate total commission with promotions
        function calculateCommission(billings, level, isFirstYear) {
            const levelKey = level.toLowerCase().replace(/\s+/g, '');
            const threshold = THRESHOLDS[levelKey];
            
            if (billings < threshold) {
                return {
                    commission: 0,
                    breakdown: [],
                    finalLevel: level,
                    promotions: [],
                    threshold: threshold
                };
            }

            const commissionableBillings = billings - threshold;
            let totalCommission = 0;
            let breakdown = [];
            let finalLevel = level;
            let promotions = [];

            // Check for promotions and calculate accordingly
            if (level === 'Consultant' && isFirstYear) {
                // Fast-track promotions
                if (billings >= PROMOTION_THRESHOLDS.fastTrack.principal) {
                    promotions = ['Consultant II', 'Senior Consultant', 'Principal Consultant'];
                    finalLevel = 'Principal Consultant';
                } else if (billings >= PROMOTION_THRESHOLDS.fastTrack.senior) {
                    promotions = ['Consultant II', 'Senior Consultant'];
                    finalLevel = 'Senior Consultant';
                } else if (billings >= PROMOTION_THRESHOLDS.fastTrack.consultantII) {
                    promotions = ['Consultant II'];
                    finalLevel = 'Consultant II';
                }
            } else {
                // Standard promotions
                if ((level === 'Consultant' || level === 'Consultant II') && billings >= PROMOTION_THRESHOLDS.standard.principal) {
                    promotions = level === 'Consultant' ? ['Senior Consultant', 'Principal Consultant'] : ['Senior Consultant', 'Principal Consultant'];
                    finalLevel = 'Principal Consultant';
                } else if ((level === 'Consultant' || level === 'Consultant II') && billings >= PROMOTION_THRESHOLDS.standard.senior) {
                    promotions = ['Senior Consultant'];
                    finalLevel = 'Senior Consultant';
                } else if (level === 'Senior Consultant' && billings >= PROMOTION_THRESHOLDS.standard.principal) {
                    promotions = ['Principal Consultant'];
                    finalLevel = 'Principal Consultant';
                }
            }

            // Calculate commission based on final level
            const rate = getCommissionRate(billings, finalLevel, isFirstYear);
            totalCommission = commissionableBillings * rate;
            
            if (totalCommission > 0) {
                breakdown.push({
                    level: `${finalLevel} (${(rate * 100).toFixed(1)}%)`,
                    billings: commissionableBillings,
                    commission: totalCommission
                });
            }

            return {
                commission: totalCommission,
                breakdown: breakdown,
                finalLevel: finalLevel,
                promotions: promotions,
                threshold: threshold
            };
        }

        // Update all calculations
        function updateCalculation() {
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currency = document.getElementById('currency').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0.75;
            const currentLevel = document.getElementById('currentLevel').value;
            const isFirstYear = document.getElementById('firstYearToggle').classList.contains('active') && currentLevel === 'Consultant';
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const teamBillings = parseFloat(document.getElementById('teamBillings').value) || 0;

            if (billings > 0) {
                const gbpBillings = currency === 'USD' ? billings * exchangeRate : billings;
                const result = calculateCommission(gbpBillings, currentLevel, isFirstYear);
                const teamBonus = currentLevel === 'Principal Consultant' ? teamBillings * 0.10 : 0;
                const total = result.commission + baseSalary + teamBonus;

                // Hide empty state
                document.getElementById('emptyState').classList.add('hidden');

                // Update earnings display
                document.getElementById('commissionValue').textContent = formatCurrency(result.commission);
                document.getElementById('salaryValue').textContent = formatCurrency(baseSalary);
                document.getElementById('teamBonusValue').textContent = formatCurrency(teamBonus);
                document.getElementById('totalValue').textContent = formatCurrency(total);

                // Show/hide rows
                document.getElementById('salaryRow').classList.toggle('hidden', baseSalary === 0);
                document.getElementById('teamBonusRow').classList.toggle('hidden', teamBonus === 0);

                // Update breakdown
                if (result.breakdown.length > 0) {
                    document.getElementById('breakdownItems').innerHTML = result.breakdown.map(item =>
                        `<div class="breakdown-item">
                            <span class="breakdown-left">${formatCurrency(item.billings)} @ ${item.level}</span>
                            <span class="breakdown-right">${formatCurrency(item.commission)}</span>
                        </div>`
                    ).join('');
                    document.getElementById('breakdown').classList.remove('hidden');
                } else {
                    document.getElementById('breakdown').classList.add('hidden');
                }

                // Update threshold status
                const meetsThreshold = gbpBillings >= result.threshold;
                const statusEl = document.getElementById('thresholdStatus');
                statusEl.className = `status ${meetsThreshold ? 'success' : 'error'}`;
                document.getElementById('statusTitle').textContent = meetsThreshold ? '‚úÖ Threshold Met' : '‚ùå Threshold Not Met';
                document.getElementById('statusText').textContent = `Required: ${formatCurrency(result.threshold)} | Current: ${formatCurrency(gbpBillings)} | ${meetsThreshold ? 'Surplus' : 'Shortfall'}: ${formatCurrency(Math.abs(gbpBillings - result.threshold))}`;
                
                document.getElementById('thresholdStatus').classList.remove('hidden');
                
                // Update promotion progress
                updatePromotionProgress(gbpBillings, result.finalLevel, currentLevel, isFirstYear, result.promotions);
                document.getElementById('promotionProgress').classList.remove('hidden');
            } else {
                // Show empty state
                document.getElementById('emptyState').classList.remove('hidden');
                
                // Reset display
                document.getElementById('commissionValue').textContent = '¬£0';
                document.getElementById('salaryValue').textContent = formatCurrency(baseSalary);
                document.getElementById('teamBonusValue').textContent = '¬£0';
                document.getElementById('totalValue').textContent = formatCurrency(baseSalary);
                
                document.getElementById('salaryRow').classList.toggle('hidden', baseSalary === 0);
                document.getElementById('teamBonusRow').classList.add('hidden');
                document.getElementById('breakdown').classList.add('hidden');
                document.getElementById('thresholdStatus').classList.add('hidden');
                document.getElementById('promotionProgress').classList.add('hidden');
            }

            // Calculate next deal
            calculateNextDeal();
        }

        // Update promotion progress
        function updatePromotionProgress(billings, finalLevel, startingLevel, isFirstYear, promotions) {
            const content = document.getElementById('promotionContent');
            let html = '';

            if (promotions.length > 0) {
                html += '<div class="promotion-badge">';
                html += '<h4>üéâ Congratulations! You\'ve been promoted to:</h4>';
                html += `<div>${promotions[promotions.length - 1]}</div>`;
                html += '</div>';
            }

            // Show progress to next promotion
            const nextPromotion = getNextPromotion(finalLevel, isFirstYear);
            if (nextPromotion) {
                const progress = Math.min(100, (billings / nextPromotion.threshold) * 100);
                const remaining = Math.max(0, nextPromotion.threshold - billings);
                
                html += '<div class="progress-container">';
                html += '<div class="progress-header">';
                html += `<span class="progress-label">Progress to ${nextPromotion.title}</span>`;
                html += `<span class="progress-type">${progress.toFixed(1)}%</span>`;
                html += '</div>';
                html += '<div class="progress-bar">';
                html += `<div class="progress-fill" style="width: ${progress}%"></div>`;
                html += '</div>';
                html += '<div class="progress-stats">';
                html += `<span>Current: ${formatCurrency(billings)}</span>`;
                html += `<span>Target: ${formatCurrency(nextPromotion.threshold)}</span>`;
                html += '</div>';
                if (remaining > 0) {
                    html += `<div class="progress-remaining">¬£${remaining.toLocaleString()} remaining to promotion</div>`;
                }
                html += '</div>';
            }

            content.innerHTML = html;
        }

        // Get next promotion target
        function getNextPromotion(currentLevel, isFirstYear) {
            if (currentLevel === 'Consultant' && isFirstYear) {
                return { title: 'Consultant II', threshold: PROMOTION_THRESHOLDS.fastTrack.consultantII };
            } else if (currentLevel === 'Consultant II' && isFirstYear) {
                return { title: 'Senior Consultant', threshold: PROMOTION_THRESHOLDS.fastTrack.senior };
            } else if (currentLevel === 'Senior Consultant' && isFirstYear) {
                return { title: 'Principal Consultant', threshold: PROMOTION_THRESHOLDS.fastTrack.principal };
            } else if (currentLevel === 'Consultant' || currentLevel === 'Consultant II') {
                return { title: 'Senior Consultant', threshold: PROMOTION_THRESHOLDS.standard.senior };
            } else if (currentLevel === 'Senior Consultant') {
                return { title: 'Principal Consultant', threshold: PROMOTION_THRESHOLDS.standard.principal };
            }
            return null;
        }
        function calculateNextDeal() {
            const nextDealValue = parseFloat(document.getElementById('nextDealValue').value) || 0;
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currency = document.getElementById('currency').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0.75;
            const currentLevel = document.getElementById('currentLevel').value;
            const isFirstYear = document.getElementById('firstYearToggle').classList.contains('active') && currentLevel === 'Consultant';

            if (nextDealValue > 0) {
                const gbpBillings = currency === 'USD' ? billings * exchangeRate : billings;
                const gbpDealValue = currency === 'USD' ? nextDealValue * exchangeRate : nextDealValue;
                
                const currentResult = calculateCommission(gbpBillings, currentLevel, isFirstYear);
                const newResult = calculateCommission(gbpBillings + gbpDealValue, currentLevel, isFirstYear);
                
                const dealCommission = newResult.commission - currentResult.commission;
                const effectiveRate = gbpDealValue > 0 ? (dealCommission / gbpDealValue) : 0;
                
                document.getElementById('nextDealCommission').textContent = formatCurrency(dealCommission);
                document.getElementById('nextDealRate').textContent = `Effective rate: ${(effectiveRate * 100).toFixed(1)}%`;
                document.getElementById('nextDealExplanation').textContent = `Commission calculated at current rate`;
                document.getElementById('nextDealResult').classList.remove('hidden');
            } else {
                document.getElementById('nextDealResult').classList.add('hidden');
            }
        }

        // Update team section visibility
        function updateTeamSection() {
            const currentLevel = document.getElementById('currentLevel').value;
            const teamSection = document.getElementById('teamSection');
            const toggleContainer = document.getElementById('toggleContainer');
            
            // Show team section for Principal Consultant
            if (currentLevel === 'Principal Consultant') {
                teamSection.classList.remove('hidden');
            } else {
                teamSection.classList.add('hidden');
                document.getElementById('teamBillings').value = '';
            }
            
            // Show fast-track toggle only for Consultant level
            if (currentLevel === 'Consultant') {
                toggleContainer.classList.remove('hidden');
            } else {
                toggleContainer.classList.add('hidden');
                document.getElementById('firstYearToggle').classList.remove('active');
            }
        }

        // Update currency section visibility
        function updateCurrencySection() {
            const currency = document.getElementById('currency').value;
            const exchangeGroup = document.getElementById('exchangeGroup');
            
            if (currency === 'USD') {
                exchangeGroup.classList.remove('hidden');
            } else {
                exchangeGroup.classList.add('hidden');
            }
        }

        // Fetch live exchange rate
        async function fetchLiveRate() {
            const button = document.getElementById('fetchRateBtn');
            const rateInput = document.getElementById('exchangeRate');
            const statusEl = document.getElementById('rateStatus');
            
            try {
                button.textContent = 'Loading...';
                button.disabled = true;
                statusEl.textContent = 'Fetching live rate...';
                
                // Using fixer.io API with CORS support
                const response = await fetch('https://api.fixer.io/latest?base=USD&symbols=GBP');
                
                if (!response.ok) {
                    // Fallback to exchangerate.host if fixer.io fails
                    const fallbackResponse = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=GBP');
                    const fallbackData = await fallbackResponse.json();
                    
                    if (fallbackData && fallbackData.rates && fallbackData.rates.GBP) {
                        const rate = fallbackData.rates.GBP.toFixed(4);
                        rateInput.value = rate;
                        statusEl.textContent = `Live rate updated: ${new Date().toLocaleTimeString()}`;
                        statusEl.style.color = '#1e3a8a';
                        updateCalculation();
                        return;
                    }
                    throw new Error('All APIs failed');
                }
                
                const data = await response.json();
                if (data && data.rates && data.rates.GBP) {
                    const rate = data.rates.GBP.toFixed(4);
                    rateInput.value = rate;
                    statusEl.textContent = `Live rate updated: ${new Date().toLocaleTimeString()}`;
                    statusEl.style.color = '#1e3a8a';
                    updateCalculation();
                } else {
                    throw new Error('Rate not found');
                }
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                // Fallback: Set a reasonable current rate
                rateInput.value = '0.79';
                statusEl.textContent = 'Using estimated rate (APIs unavailable). Please verify current rate.';
                statusEl.style.color = '#999';
                updateCalculation();
            } finally {
                button.textContent = 'Live Rate';
                button.disabled = false;
            }
        }
        let savedCalculationsData = [];

        // Save calculation
        function saveCalculation() {
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currentLevel = document.getElementById('currentLevel').value;
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const currency = document.getElementById('currency').value;
            const isFirstYear = document.getElementById('firstYearToggle').classList.contains('active');
            const teamBillings = parseFloat(document.getElementById('teamBillings').value) || 0;
            
            if (billings === 0) {
                alert('Please enter your billings before saving');
                return;
            }
            
            const calculation = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                billings: billings,
                currency: currency,
                currentLevel: currentLevel,
                baseSalary: baseSalary,
                isFirstYear: isFirstYear,
                teamBillings: teamBillings,
                totalEarnings: document.getElementById('totalValue').textContent
            };
            
            // Add to beginning of array
            savedCalculationsData.unshift(calculation);
            
            // Keep only last 5 calculations
            savedCalculationsData = savedCalculationsData.slice(0, 5);
            
            // Update display
            displaySavedCalculations();
            
            // Show success message
            alert('Calculation saved successfully!');
        }

        // Load calculation
        function loadCalculation(id) {
            const calculation = savedCalculationsData.find(calc => calc.id === id);
            
            if (calculation) {
                document.getElementById('billings').value = calculation.billings;
                document.getElementById('currency').value = calculation.currency;
                document.getElementById('currentLevel').value = calculation.currentLevel;
                document.getElementById('baseSalary').value = calculation.baseSalary || '';
                document.getElementById('teamBillings').value = calculation.teamBillings || '';
                
                if (calculation.isFirstYear) {
                    document.getElementById('firstYearToggle').classList.add('active');
                } else {
                    document.getElementById('firstYearToggle').classList.remove('active');
                }
                
                // Update dependent sections
                updateCurrencySection();
                updateTeamSection();
                updateCalculation();
            }
        }

        // Delete calculation
        function deleteCalculation(id) {
            if (confirm('Are you sure you want to delete this saved calculation?')) {
                savedCalculationsData = savedCalculationsData.filter(calc => calc.id !== id);
                displaySavedCalculations();
            }
        }

        // Display saved calculations
        function displaySavedCalculations() {
            const savedSection = document.getElementById('savedCalculations');
            const savedList = document.getElementById('savedList');
            
            if (savedCalculationsData.length === 0) {
                savedSection.classList.add('hidden');
                return;
            }
            
            savedSection.classList.remove('hidden');
            
            savedList.innerHTML = savedCalculationsData.map(calc => `
                <div class="saved-item">
                    <div class="saved-item-header">
                        <div class="saved-item-title">${calc.currentLevel} - ${calc.currency} ${calc.billings.toLocaleString()}</div>
                        <div class="saved-item-date">${calc.date}</div>
                    </div>
                    <div class="saved-item-details">
                        Total Earnings: ${calc.totalEarnings}${calc.baseSalary ? ` (Salary: ¬£${calc.baseSalary.toLocaleString()})` : ''}
                    </div>
                    <div class="saved-item-actions">
                        <button class="load-btn" onclick="loadCalculation(${calc.id})">Load</button>
                        <button class="delete-btn" onclick="deleteCalculation(${calc.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        function exportResults() {
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currentLevel = document.getElementById('currentLevel').value;
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const currency = document.getElementById('currency').value;
            
            if (billings === 0) {
                alert('Please enter your billings before exporting');
                return;
            }
            
            const exportData = `TY-G Commission Calculator Results
================================

Personal Details:
- Starting Level: ${currentLevel}
- Annual Billings: ${currency} ${billings.toLocaleString()}
- Base Salary: ¬£${baseSalary.toLocaleString()}

Total Earnings: ${document.getElementById('totalValue').textContent}

Generated on: ${new Date().toLocaleDateString()}`;
            
            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TYG-Commission-Report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Reset form
        function resetForm() {
            document.getElementById('billings').value = '';
            document.getElementById('currency').value = 'GBP';
            document.getElementById('exchangeRate').value = '0.75';
            document.getElementById('nextDealValue').value = '';
            document.getElementById('currentLevel').value = 'Consultant';
            document.getElementById('baseSalary').value = '';
            document.getElementById('teamBillings').value = '';
            document.getElementById('firstYearToggle').classList.add('active');
            
            updateCurrencySection();
            updateTeamSection();
            updateCalculation();
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Input listeners
            ['billings', 'nextDealValue', 'baseSalary', 'teamBillings', 'exchangeRate'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculation);
            });

            ['currency', 'currentLevel'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (id === 'currency') updateCurrencySection();
                    if (id === 'currentLevel') updateTeamSection();
                    updateCalculation();
                });
            });

            // Toggle listener
            document.getElementById('firstYearToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                updateCalculation();
            });

            // Toggle info dropdown
            document.getElementById('infoToggle').addEventListener('click', function() {
                const content = document.getElementById('infoContent');
                const toggle = document.getElementById('infoToggle');
                
                content.classList.toggle('hidden');
                toggle.classList.toggle('active');
            });

            // Button listeners
            document.getElementById('resetButton').addEventListener('click', resetForm);
            document.getElementById('saveButton').addEventListener('click', saveCalculation);
            document.getElementById('exportButton').addEventListener('click', exportResults);

            // Initial setup
            updateCurrencySection();
            updateTeamSection();
            displaySavedCalculations();
            updateCalculation();
        });
    </script>
</body>
</html>
