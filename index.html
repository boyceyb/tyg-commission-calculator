<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYG Commission Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; padding: 20px; color: #2d3748; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 12px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; }
        .logo { font-weight: 900; font-size: 24px; letter-spacing: 2px; color: #1e293b; }
        .logo .dash { color: #64748b; margin: 0 4px; }
        .title { margin-left: 24px; }
        .title h1 { font-size: 24px; font-weight: bold; color: #1e293b; margin: 0; }
        .title p { font-size: 14px; color: #64748b; margin-top: 4px; }
        .icon { background: #1e293b; padding: 12px; border-radius: 8px; color: white; font-size: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; border: 1px solid #e2e8f0; }
        .card h3 { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .input-group input, .input-group select { width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; transition: border-color 0.2s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .toggle-container { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .toggle { position: relative; width: 44px; height: 24px; background: #cbd5e1; border-radius: 12px; cursor: pointer; transition: background 0.3s; }
        .toggle.active { background: #10b981; }
        .toggle-thumb { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 10px; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toggle.active .toggle-thumb { transform: translateX(20px); }
        .breakdown { background: #f8fafc; padding: 16px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
        .breakdown h4 { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
        .breakdown-item { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 8px; }
        .breakdown-left { color: #64748b; }
        .breakdown-right { font-weight: 500; color: #1e293b; }
        .earnings-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-size: 14px; }
        .earnings-item:last-child { margin-bottom: 0; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 18px; font-weight: bold; }
        .earnings-label { color: #64748b; }
        .earnings-value { font-weight: bold; }
        .earnings-value.commission { color: #7c3aed; }
        .earnings-value.salary { color: #e11d48; }
        .earnings-value.team { color: #d97706; }
        .earnings-value.total { color: #1e293b; }
        .status { padding: 16px; border-radius: 6px; margin-bottom: 16px; }
        .status.success { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .status.error { background: #fef2f2; border: 1px solid #fecaca; }
        .status.info { background: #eff6ff; border: 1px solid #bfdbfe; }
        .status-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
        .status.success .status-title { color: #166534; }
        .status.error .status-title { color: #dc2626; }
        .status.info .status-title { color: #1d4ed8; }
        .status-text { font-size: 14px; color: #64748b; }
        .progress-container { margin-bottom: 16px; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .progress-label { font-size: 14px; font-weight: 500; color: #374151; }
        .progress-type { font-size: 12px; color: #64748b; }
        .progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #3b82f6, #10b981); transition: width 0.3s; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-top: 4px; }
        .progress-remaining { font-size: 12px; color: #64748b; margin-top: 8px; }
        .promotion-badge { background: #dcfce7; color: #166534; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #bbf7d0; }
        .promotion-badge h4 { font-weight: 600; margin-bottom: 4px; }
        .next-deal-card { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .next-deal-card h4 { color: #0c4a6e; font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .deal-result { background: white; border-radius: 6px; padding: 16px; border: 1px solid #bae6fd; }
        .deal-value { font-size: 18px; font-weight: bold; color: #0c4a6e; margin-bottom: 4px; }
        .deal-rate { font-size: 14px; color: #0369a1; }
        .reset-btn { background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; width: 100%; }
        .reset-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3); }
        .hidden { display: none; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .header { flex-direction: column; text-align: center; gap: 16px; } .header-left { flex-direction: column; gap: 16px; } .title { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">TY<span class="dash">-</span>G</div>
                <div class="title">
                    <h1>Commission Calculator</h1>
                    <p>Calculate your earnings and track promotion progress</p>
                </div>
            </div>
            <div class="icon">üî¢</div>
        </div>
        <div class="grid">
            <div class="card">
                <h3>üí∑ Current Year Billings</h3>
                <div class="input-group">
                    <label>Annual Billings (Year to Date)</label>
                    <input type="number" id="billings" placeholder="Current year billings...">
                </div>
                <div class="input-group">
                    <label>Currency</label>
                    <select id="currency">
                        <option value="GBP">GBP (¬£)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
                <div class="input-group hidden" id="exchangeGroup">
                    <label>USD/GBP Exchange Rate</label>
                    <input type="number" id="exchangeRate" value="1.27" step="0.01" placeholder="Exchange rate">
                </div>
                
                <div class="next-deal-card">
                    <h4>üéØ Next Deal Calculator</h4>
                    <div class="input-group">
                        <label>Next Deal Value</label>
                        <input type="number" id="nextDealValue" placeholder="Deal value...">
                        <small style="font-size: 12px; color: #64748b; margin-top: 4px; display: block;">Calculate commission on your next specific deal</small>
                    </div>
                </div>
                
                <h3 style="margin-top: 24px;">‚öôÔ∏è Role & Settings</h3>
                <div class="input-group">
                    <label>Starting Level</label>
                    <select id="currentLevel">
                        <option value="Consultant">Consultant</option>
                        <option value="Consultant II">Consultant II</option>
                        <option value="Senior Consultant">Senior Consultant</option>
                        <option value="Principal Consultant">Principal Consultant</option>
                    </select>
                </div>
                <div class="toggle-container" id="toggleContainer">
                    <div>
                        <div style="font-size: 14px; font-weight: 500;">First Year?</div>
                        <div style="font-size: 12px; color: #64748b;">Enables fast-track promotions</div>
                    </div>
                    <div class="toggle active" id="firstYearToggle">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Base Salary (¬£)</label>
                    <input type="number" id="baseSalary" placeholder="Base salary (¬£)">
                </div>
                <div id="teamSection" class="hidden">
                    <h3 style="margin-top: 20px;">üë• Team Billings</h3>
                    <div class="input-group">
                        <label>Team Annual Billings (¬£)</label>
                        <input type="number" id="teamBillings" placeholder="Team annual billings (¬£)">
                        <small style="font-size: 12px; color: #64748b;">10% commission on team billings</small>
                    </div>
                </div>
                <button class="reset-btn" id="resetButton">üîÑ Clear All Fields</button>
            </div>
            <div class="card">
                <h3>üìä Your Earnings</h3>
                <div id="breakdown" class="breakdown hidden">
                    <h4>Commission Breakdown:</h4>
                    <div id="breakdownItems"></div>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Commission</span>
                    <span class="earnings-value commission" id="commissionValue">¬£0</span>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Base Salary</span>
                    <span class="earnings-value salary" id="salaryValue">¬£0</span>
                </div>
                <div class="earnings-item hidden" id="teamBonusRow">
                    <span class="earnings-label">Team Bonus</span>
                    <span class="earnings-value team" id="teamBonusValue">¬£0</span>
                </div>
                <div class="earnings-item">
                    <span class="earnings-label">Total Earnings</span>
                    <span class="earnings-value total" id="totalValue">¬£0</span>
                </div>
                
                <div id="nextDealResult" class="status info hidden">
                    <div class="status-title">üéØ Next Deal Commission</div>
                    <div class="deal-result">
                        <div class="deal-value" id="nextDealCommission">¬£0</div>
                        <div class="deal-rate" id="nextDealRate">Commission rate: 0%</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;" id="nextDealExplanation"></div>
                    </div>
                </div>
                
                <div id="thresholdStatus" class="status hidden">
                    <div class="status-title" id="statusTitle">Threshold Status</div>
                    <div class="status-text" id="statusText">Enter billings to see threshold status</div>
                </div>
                <div id="promotionProgress" class="hidden">
                    <h3 style="margin-top: 20px;">üìà Promotion Progress</h3>
                    <div id="promotionContent"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Constants - Updated to match official policy
        const thresholds = { 
            consultant: 35000, 
            consultantii: 40000, 
            seniorconsultant: 40000, 
            principalconsultant: 40000 
        };
        
        const promotionThresholds = { 
            fastTrack: { 
                consultantII: 100000, 
                senior: 140000, 
                principal: 180000 
            }, 
            standard: { 
                senior: 160000, 
                principal: 200000 
            } 
        };

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', { 
                style: 'currency', 
                currency: 'GBP', 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(Math.round(amount || 0));
        }

        function getCurrentCommissionRate(currentBillings, currentLevel, isFirstYear) {
            const levelKey = currentLevel.toLowerCase().replace(/\s+/g, '');
            const yearlyThreshold = thresholds[levelKey];
            
            if (currentBillings < yearlyThreshold) {
                return { rate: 0, explanation: `Must reach ${formatCurrency(yearlyThreshold)} threshold first` };
            }
            
            const commissionableBillings = currentBillings - yearlyThreshold;
            
            if (currentLevel === 'Consultant' && isFirstYear) {
                if (currentBillings >= promotionThresholds.fastTrack.principal) {
                    const principalBillings = commissionableBillings - (promotionThresholds.fastTrack.principal - yearlyThreshold);
                    return getPrincipalTierRate(principalBillings);
                } else if (currentBillings >= promotionThresholds.fastTrack.senior) {
                    return { rate: 0.25, explanation: 'Senior Consultant level (fast-track)' };
                } else if (currentBillings >= promotionThresholds.fastTrack.consultantII) {
                    return { rate: 0.225, explanation: 'Consultant II level (fast-track)' };
                } else {
                    return { rate: 0.20, explanation: 'Consultant level' };
                }
            } else {
                if ((currentLevel === 'Consultant' || currentLevel === 'Consultant II') && currentBillings >= promotionThresholds.standard.principal) {
                    const principalBillings = commissionableBillings - (promotionThresholds.standard.principal - yearlyThreshold);
                    return getPrincipalTierRate(principalBillings);
                } else if ((currentLevel === 'Consultant' || currentLevel === 'Consultant II') && currentBillings >= promotionThresholds.standard.senior) {
                    return getSeniorTierRate(commissionableBillings - (promotionThresholds.standard.senior - yearlyThreshold));
                } else if (currentLevel === 'Senior Consultant' && currentBillings >= promotionThresholds.standard.principal) {
                    const principalBillings = commissionableBillings - (promotionThresholds.standard.principal - yearlyThreshold);
                    return getPrincipalTierRate(principalBillings);
                } else if (currentLevel === 'Senior Consultant') {
                    return getSeniorTierRate(commissionableBillings);
                } else if (currentLevel === 'Principal Consultant') {
                    return getPrincipalTierRate(commissionableBillings);
                } else if (currentLevel === 'Consultant II') {
                    return { rate: 0.225, explanation: 'Consultant II level' };
                } else if (currentLevel === 'Consultant') {
                    return { rate: 0.20, explanation: 'Consultant level' };
                }
            }
            
            return { rate: 0, explanation: 'Unable to determine rate' };
        }

        function getSeniorTierRate(seniorBillings) {
            // Policy: 25% on ¬£40k-¬£100k, then 30% on ¬£100k-¬£200k
            if (seniorBillings < 60000) { // First ¬£60k above ¬£40k threshold = up to ¬£100k total
                return { rate: 0.25, explanation: 'Senior Consultant - first tier (25%)' };
            } else {
                return { rate: 0.30, explanation: 'Senior Consultant - second tier (30%)' };
            }
        }

        function getPrincipalTierRate(principalBillings) {
            // Policy: 25% on ¬£40k-¬£100k, 30% on ¬£100k-¬£200k, 35% on ¬£200k-¬£300k, 40% on ¬£300k-¬£400k, 50% on ¬£400k+
            if (principalBillings < 60000) { // ¬£40k-¬£100k range
                return { rate: 0.25, explanation: 'Principal Consultant - tier 1 (25%)' };
            } else if (principalBillings < 160000) { // ¬£100k-¬£200k range
                return { rate: 0.30, explanation: 'Principal Consultant - tier 2 (30%)' };
            } else if (principalBillings < 260000) { // ¬£200k-¬£300k range
                return { rate: 0.35, explanation: 'Principal Consultant - tier 3 (35%)' };
            } else if (principalBillings < 360000) { // ¬£300k-¬£400k range
                return { rate: 0.40, explanation: 'Principal Consultant - tier 4 (40%)' };
            } else { // ¬£400k+ range
                return { rate: 0.50, explanation: 'Principal Consultant - tier 5 (50%)' };
            }
        }

        function calculatePrincipalTiers(billings, breakdown) {
            let commission = 0;
            let remaining = billings;
            
            // Based on policy: 25% (¬£40k-¬£100k), 30% (¬£100k-¬£200k), 35% (¬£200k-¬£300k), 40% (¬£300k-¬£400k), 50% (¬£400k+)
            // Note: billings passed here is already above the ¬£40k threshold
            
            // Tier 1: First ¬£60k at 25% (represents ¬£40k-¬£100k range)
            if (remaining > 0) {
                const tier1Amount = Math.min(remaining, 60000);
                const tier1Commission = tier1Amount * 0.25;
                commission += tier1Commission;
                breakdown.push({ level: 'Principal Tier 1 (25%)', billings: tier1Amount, commission: tier1Commission });
                remaining -= tier1Amount;
            }
            
            // Tier 2: Next ¬£100k at 30% (represents ¬£100k-¬£200k range)
            if (remaining > 0) {
                const tier2Amount = Math.min(remaining, 100000);
                const tier2Commission = tier2Amount * 0.30;
                commission += tier2Commission;
                breakdown.push({ level: 'Principal Tier 2 (30%)', billings: tier2Amount, commission: tier2Commission });
                remaining -= tier2Amount;
            }
            
            // Tier 3: Next ¬£100k at 35% (represents ¬£200k-¬£300k range)
            if (remaining > 0) {
                const tier3Amount = Math.min(remaining, 100000);
                const tier3Commission = tier3Amount * 0.35;
                commission += tier3Commission;
                breakdown.push({ level: 'Principal Tier 3 (35%)', billings: tier3Amount, commission: tier3Commission });
                remaining -= tier3Amount;
            }
            
            // Tier 4: Next ¬£100k at 40% (represents ¬£300k-¬£400k range)
            if (remaining > 0) {
                const tier4Amount = Math.min(remaining, 100000);
                const tier4Commission = tier4Amount * 0.40;
                commission += tier4Commission;
                breakdown.push({ level: 'Principal Tier 4 (40%)', billings: tier4Amount, commission: tier4Commission });
                remaining -= tier4Amount;
            }
            
            // Tier 5: Remaining at 50% (represents ¬£400k+ range)
            if (remaining > 0) {
                const tier5Commission = remaining * 0.50;
                commission += tier5Commission;
                breakdown.push({ level: 'Principal Tier 5 (50%)', billings: remaining, commission: tier5Commission });
            }
            
            return commission;
        }

        function calculateNextDealCommission() {
            const nextDealValue = parseFloat(document.getElementById('nextDealValue').value) || 0;
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currency = document.getElementById('currency').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1.27;
            const currentLevel = document.getElementById('currentLevel').value;
            const isFirstYear = document.getElementById('firstYearToggle').classList.contains('active') && currentLevel === 'Consultant';

            if (nextDealValue > 0) {
                const gbpBillings = currency === 'USD' ? billings / exchangeRate : billings;
                const gbpDealValue = currency === 'USD' ? nextDealValue / exchangeRate : nextDealValue;
                
                // Calculate commission with the deal added (accounting for promotions)
                const currentResult = calculateCommissionWithPromotions(gbpBillings, currentLevel, isFirstYear);
                const newResult = calculateCommissionWithPromotions(gbpBillings + gbpDealValue, currentLevel, isFirstYear);
                
                const dealCommission = newResult.totalCommission - currentResult.totalCommission;
                const effectiveRate = gbpDealValue > 0 ? (dealCommission / gbpDealValue) : 0;
                
                // Create detailed explanation
                let explanation = '';
                
                // Check for level promotions
                if (newResult.promotions.length > currentResult.promotions.length) {
                    const newPromotions = newResult.promotions.slice(currentResult.promotions.length);
                    explanation = `üéâ This deal promotes you to ${newPromotions.join(' ‚Üí ')}! `;
                }
                
                // Check for tier changes within Principal level
                if (currentResult.finalLevel === 'Principal Consultant' && newResult.finalLevel === 'Principal Consultant') {
                    const currentTiers = currentResult.breakdown.filter(b => b.level.includes('Principal')).length;
                    const newTiers = newResult.breakdown.filter(b => b.level.includes('Principal')).length;
                    
                    if (newTiers > currentTiers) {
                        explanation += `üìà Advances to higher Principal commission tier(s). `;
                    }
                }
                
                // Show breakdown for complex deals
                const dealBreakdown = newResult.breakdown.slice(currentResult.breakdown.length);
                if (dealBreakdown.length > 1) {
                    explanation += `Commission split across ${dealBreakdown.length} tiers: `;
                    dealBreakdown.forEach((tier, index) => {
                        const rate = (tier.commission / tier.billings * 100).toFixed(1);
                        explanation += `${formatCurrency(tier.billings)} at ${rate}%`;
                        if (index < dealBreakdown.length - 1) explanation += ', ';
                    });
                } else if (dealBreakdown.length === 1) {
                    const rate = (dealBreakdown[0].commission / dealBreakdown[0].billings * 100).toFixed(1);
                    if (!explanation) {
                        explanation = `Single tier: ${dealBreakdown[0].level}`;
                    }
                } else {
                    // Fallback to current rate explanation
                    const { explanation: rateExplanation } = getCurrentCommissionRate(gbpBillings + gbpDealValue, newResult.finalLevel, isFirstYear);
                    if (!explanation) {
                        explanation = rateExplanation;
                    }
                }
                
                document.getElementById('nextDealCommission').textContent = formatCurrency(dealCommission);
                document.getElementById('nextDealRate').textContent = `Effective rate: ${(effectiveRate * 100).toFixed(1)}%`;
                document.getElementById('nextDealExplanation').textContent = explanation;
                document.getElementById('nextDealResult').classList.remove('hidden');
            } else {
                document.getElementById('nextDealResult').classList.add('hidden');
            }
        }

        function calculateCommissionWithPromotions(gbpBillings, startingLevel, firstYear) {
            const levelKey = startingLevel.toLowerCase().replace(/\s+/g, '');
            const yearlyThreshold = thresholds[levelKey];
            const commissionableBillings = Math.max(0, gbpBillings - yearlyThreshold);
            let totalCommission = 0, finalLevel = startingLevel, promotions = [], breakdown = [];

            if (commissionableBillings <= 0) {
                return { totalCommission: 0, finalLevel, promotions, breakdown, yearlyThreshold };
            }

            if (startingLevel === 'Consultant' && firstYear) {
                // Fast track logic
                let remaining = commissionableBillings;
                if (gbpBillings >= promotionThresholds.fastTrack.consultantII) {
                    const consultantPortion = Math.min(remaining, promotionThresholds.fastTrack.consultantII - yearlyThreshold);
                    const consultantCommission = consultantPortion * 0.20;
                    totalCommission += consultantCommission;
                    breakdown.push({ level: 'Consultant (20%)', billings: consultantPortion, commission: consultantCommission });
                    remaining -= consultantPortion;
                    finalLevel = 'Consultant II';
                    promotions.push('Consultant II');

                    if (remaining > 0 && gbpBillings >= promotionThresholds.fastTrack.senior) {
                        const consultantIIPortion = Math.min(remaining, promotionThresholds.fastTrack.senior - promotionThresholds.fastTrack.consultantII);
                        const consultantIICommission = consultantIIPortion * 0.225;
                        totalCommission += consultantIICommission;
                        breakdown.push({ level: 'Consultant II (22.5%)', billings: consultantIIPortion, commission: consultantIICommission });
                        remaining -= consultantIIPortion;
                        finalLevel = 'Senior Consultant';
                        promotions.push('Senior Consultant');

                        if (remaining > 0 && gbpBillings >= promotionThresholds.fastTrack.principal) {
                            const seniorPortion = Math.min(remaining, promotionThresholds.fastTrack.principal - promotionThresholds.fastTrack.senior);
                            const seniorCommission = seniorPortion * 0.25;
                            totalCommission += seniorCommission;
                            breakdown.push({ level: 'Senior Consultant (25%)', billings: seniorPortion, commission: seniorCommission });
                            remaining -= seniorPortion;
                            finalLevel = 'Principal Consultant';
                            promotions.push('Principal Consultant');
                            
                            if (remaining > 0) {
                                totalCommission += calculatePrincipalTiers(remaining, breakdown);
                            }
                        } else if (remaining > 0) {
                            const seniorCommission = remaining * 0.25;
                            totalCommission += seniorCommission;
                            breakdown.push({ level: 'Senior Consultant (25%)', billings: remaining, commission: seniorCommission });
                        }
                    } else if (remaining > 0) {
                        const consultantIICommission = remaining * 0.225;
                        totalCommission += consultantIICommission;
                        breakdown.push({ level: 'Consultant II (22.5%)', billings: remaining, commission: consultantIICommission });
                    }
                } else {
                    totalCommission = commissionableBillings * 0.20;
                    breakdown.push({ level: 'Consultant (20%)', billings: commissionableBillings, commission: totalCommission });
                }
            } else {
                // Standard progression or other levels
                if ((startingLevel === 'Consultant' || startingLevel === 'Consultant II') && gbpBillings >= promotionThresholds.standard.senior) {
                    let remaining = commissionableBillings;
                    const startingRate = startingLevel === 'Consultant' ? 0.20 : 0.225;
                    const startingPortion = Math.min(remaining, promotionThresholds.standard.senior - yearlyThreshold);
                    const startingCommission = startingPortion * startingRate;
                    totalCommission += startingCommission;
                    breakdown.push({ level: `${startingLevel} (${(startingRate * 100).toFixed(1)}%)`, billings: startingPortion, commission: startingCommission });
                    remaining -= startingPortion;
                    finalLevel = 'Senior Consultant';
                    promotions.push('Senior Consultant');

                    if (remaining > 0 && gbpBillings >= promotionThresholds.standard.principal) {
                        const seniorPortion = Math.min(remaining, promotionThresholds.standard.principal - promotionThresholds.standard.senior);
                        const seniorCommission = seniorPortion * 0.25;
                        totalCommission += seniorCommission;
                        breakdown.push({ level: 'Senior Consultant (25%)', billings: seniorPortion, commission: seniorCommission });
                        remaining -= seniorPortion;
                        finalLevel = 'Principal Consultant';
                        promotions.push('Principal Consultant');
                        
                        if (remaining > 0) {
                            totalCommission += calculatePrincipalTiers(remaining, breakdown);
                        }
                    } else if (remaining > 0) {
                        const seniorCommission = remaining * 0.25;
                        totalCommission += seniorCommission;
                        breakdown.push({ level: 'Senior Consultant (25%)', billings: remaining, commission: seniorCommission });
                    }
                } else if (startingLevel === 'Senior Consultant' && gbpBillings >= promotionThresholds.standard.principal) {
                    let remaining = commissionableBillings;
                    const seniorPortion = Math.min(remaining, promotionThresholds.standard.principal - yearlyThreshold);
                    const seniorCommission = seniorPortion * 0.25;
                    totalCommission += seniorCommission;
                    breakdown.push({ level: 'Senior Consultant (25%)', billings: seniorPortion, commission: seniorCommission });
                    remaining -= seniorPortion;
                    finalLevel = 'Principal Consultant';
                    promotions.push('Principal Consultant');
                    
                    if (remaining > 0) {
                        totalCommission += calculatePrincipalTiers(remaining, breakdown);
                    }
                } else {
                    // No promotions - calculate at current level
                    if (startingLevel === 'Senior Consultant') {
                        let commission = 0;
                        // Policy: 25% on ¬£40k-¬£100k, 30% on ¬£100k-¬£200k
                        if (commissionableBillings <= 60000) { // Up to ¬£100k total billings
                            commission = commissionableBillings * 0.25;
                            breakdown.push({ level: 'Senior Consultant (25%)', billings: commissionableBillings, commission });
                        } else {
                            // First ¬£60k at 25% (¬£40k-¬£100k range)
                            const firstTier = 60000 * 0.25;
                            commission += firstTier;
                            breakdown.push({ level: 'Senior Consultant Tier 1 (25%)', billings: 60000, commission: firstTier });
                            
                            // Remainder at 30% (¬£100k-¬£200k range)
                            const remainder = (commissionableBillings - 60000) * 0.30;
                            commission += remainder;
                            breakdown.push({ level: 'Senior Consultant Tier 2 (30%)', billings: commissionableBillings - 60000, commission: remainder });
                        }
                        totalCommission = commission;
                    } else if (startingLevel === 'Principal Consultant') {
                        totalCommission = calculatePrincipalTiers(commissionableBillings, breakdown);
                    } else if (startingLevel === 'Consultant II') {
                        totalCommission = commissionableBillings * 0.225;
                        breakdown.push({ level: 'Consultant II (22.5%)', billings: commissionableBillings, commission: totalCommission });
                    } else if (startingLevel === 'Consultant') {
                        totalCommission = commissionableBillings * 0.20;
                        breakdown.push({ level: 'Consultant (20%)', billings: commissionableBillings, commission: totalCommission });
                    }
                }
            }

            return { totalCommission, finalLevel, promotions, breakdown, yearlyThreshold };
        }

        function updatePromotionProgress(gbpBillings, finalLevel, startingLevel, isFirstYear, promotions) {
            const content = document.getElementById('promotionContent');
            let html = '';

            if (promotions.length > 0) {
                html += '<div class="promotion-badge">';
                html += '<h4>üéâ Congratulations! You\'ve been promoted to:</h4>';
                html += `<div>${promotions[promotions.length - 1]}</div>`;
                html += '</div>';
            }

            // Show progress to next promotion
            const nextPromotion = getNextPromotion(finalLevel, isFirstYear);
            if (nextPromotion) {
                const progress = (gbpBillings / nextPromotion.threshold) * 100;
                const remaining = Math.max(0, nextPromotion.threshold - gbpBillings);
                
                html += '<div class="progress-container">';
                html += '<div class="progress-header">';
                html += `<span class="progress-label">Progress to ${nextPromotion.title}</span>`;
                html += `<span class="progress-type">${Math.min(100, progress).toFixed(1)}%</span>`;
                html += '</div>';
                html += '<div class="progress-bar">';
                html += `<div class="progress-fill" style="width: ${Math.min(100, progress)}%"></div>`;
                html += '</div>';
                html += '<div class="progress-stats">';
                html += `<span>Current: ${formatCurrency(gbpBillings)}</span>`;
                html += `<span>Target: ${formatCurrency(nextPromotion.threshold)}</span>`;
                html += '</div>';
                if (remaining > 0) {
                    html += `<div class="progress-remaining">¬£${remaining.toLocaleString()} remaining to promotion</div>`;
                }
                html += '</div>';
            }

            content.innerHTML = html;
        }

        function getNextPromotion(currentLevel, isFirstYear) {
            if (currentLevel === 'Consultant' && isFirstYear) {
                return { title: 'Consultant II', threshold: promotionThresholds.fastTrack.consultantII };
            } else if (currentLevel === 'Consultant II' && isFirstYear) {
                return { title: 'Senior Consultant', threshold: promotionThresholds.fastTrack.senior };
            } else if (currentLevel === 'Senior Consultant' && isFirstYear) {
                return { title: 'Principal Consultant', threshold: promotionThresholds.fastTrack.principal };
            } else if (currentLevel === 'Consultant' || currentLevel === 'Consultant II') {
                return { title: 'Senior Consultant', threshold: promotionThresholds.standard.senior };
            } else if (currentLevel === 'Senior Consultant') {
                return { title: 'Principal Consultant', threshold: promotionThresholds.standard.principal };
            }
            return null;
        }

        function updateCalculation() {
            const billings = parseFloat(document.getElementById('billings').value) || 0;
            const currency = document.getElementById('currency').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 1.27;
            const currentLevel = document.getElementById('currentLevel').value;
            const isFirstYear = document.getElementById('firstYearToggle').classList.contains('active') && currentLevel === 'Consultant';
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const teamBillings = parseFloat(document.getElementById('teamBillings').value) || 0;

            // Calculate next deal commission
            calculateNextDealCommission();

            if (billings > 0) {
                const gbpBillings = currency === 'USD' ? billings / exchangeRate : billings;
                const result = calculateCommissionWithPromotions(gbpBillings, currentLevel, isFirstYear);
                const { totalCommission, finalLevel, promotions, breakdown, yearlyThreshold } = result;
                const teamBonus = finalLevel === 'Principal Consultant' ? teamBillings * 0.10 : 0;
                const total = totalCommission + baseSalary + teamBonus;

                // Update display
                document.getElementById('commissionValue').textContent = formatCurrency(totalCommission);
                document.getElementById('salaryValue').textContent = formatCurrency(baseSalary);
                document.getElementById('teamBonusValue').textContent = formatCurrency(teamBonus);
                document.getElementById('totalValue').textContent = formatCurrency(total);

                // Show/hide team bonus
                document.getElementById('teamBonusRow').classList.toggle('hidden', teamBonus === 0);

                // Update breakdown
                const breakdownEl = document.getElementById('breakdown');
                const breakdownItems = document.getElementById('breakdownItems');
                if (breakdown.length > 0 && totalCommission > 0) {
                    breakdownItems.innerHTML = breakdown.map(item => 
                        `<div class="breakdown-item">
                            <span class="breakdown-left">${formatCurrency(item.billings)} @ ${item.level}</span>
                            <span class="breakdown-right">${formatCurrency(item.commission)}</span>
                        </div>`
                    ).join('');
                    breakdownEl.classList.remove('hidden');
                } else {
                    breakdownEl.classList.add('hidden');
                }

                // Update threshold status
                const meetsThreshold = gbpBillings >= yearlyThreshold;
                const statusEl = document.getElementById('thresholdStatus');
                const statusTitle = document.getElementById('statusTitle');
                const statusText = document.getElementById('statusText');
                statusEl.className = `status ${meetsThreshold ? 'success' : 'error'}`;
                statusTitle.textContent = meetsThreshold ? '‚úÖ Threshold Met' : '‚ùå Threshold Not Met';
                statusText.textContent = `Required: ${formatCurrency(yearlyThreshold)} | Current: ${formatCurrency(gbpBillings)} | ${meetsThreshold ? 'Surplus' : 'Shortfall'}: ${formatCurrency(Math.abs(gbpBillings - yearlyThreshold))}`;

                updatePromotionProgress(gbpBillings, finalLevel, currentLevel, isFirstYear, promotions);
                document.getElementById('thresholdStatus').classList.remove('hidden');
                document.getElementById('promotionProgress').classList.remove('hidden');
            } else {
                document.getElementById('commissionValue').textContent = '¬£0';
                document.getElementById('salaryValue').textContent = formatCurrency(baseSalary);
                document.getElementById('teamBonusValue').textContent = '¬£0';
                document.getElementById('totalValue').textContent = formatCurrency(baseSalary);
                document.getElementById('breakdown').classList.add('hidden');
                document.getElementById('thresholdStatus').classList.add('hidden');
                document.getElementById('promotionProgress').classList.add('hidden');
                document.getElementById('teamBonusRow').classList.add('hidden');
            }
        }

        function updateTeamSection() {
            const currentLevel = document.getElementById('currentLevel').value;
            const teamSection = document.getElementById('teamSection');
            
            if (currentLevel === 'Principal Consultant') {
                teamSection.classList.remove('hidden');
            } else {
                teamSection.classList.add('hidden');
                document.getElementById('teamBillings').value = '';
            }
        }

        function updateCurrencySection() {
            const currency = document.getElementById('currency').value;
            const exchangeGroup = document.getElementById('exchangeGroup');
            
            if (currency === 'USD') {
                exchangeGroup.classList.remove('hidden');
            } else {
                exchangeGroup.classList.add('hidden');
            }
        }

        function resetForm() {
            document.getElementById('billings').value = '';
            document.getElementById('currency').value = 'GBP';
            document.getElementById('exchangeRate').value = '1.27';
            document.getElementById('nextDealValue').value = '';
            document.getElementById('currentLevel').value = 'Consultant';
            document.getElementById('baseSalary').value = '';
            document.getElementById('teamBillings').value = '';
            document.getElementById('firstYearToggle').classList.add('active');
            
            updateCurrencySection();
            updateTeamSection();
            updateCalculation();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Input event listeners
            ['billings', 'nextDealValue', 'baseSalary', 'teamBillings', 'exchangeRate'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculation);
            });

            ['currency', 'currentLevel'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (id === 'currency') updateCurrencySection();
                    if (id === 'currentLevel') updateTeamSection();
                    updateCalculation();
                });
            });

            // Toggle event listener
            document.getElementById('firstYearToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                updateCalculation();
            });

            // Reset button
            document.getElementById('resetButton').addEventListener('click', resetForm);

            // Initial setup
            updateCurrencySection();
            updateTeamSection();
            updateCalculation();
        });
    </script>
</body>
</html>
